echo "[husky] formatting database types if modified..."
if git diff --name-only HEAD @{push} 2>/dev/null | grep -q "packages/shared/src/types/database.types.ts"; then
  if [ -f "packages/shared/src/types/database.types.ts" ]; then
    echo "  → database.types.ts will be pushed, ensuring it's formatted..."
    biome format --write packages/shared/src/types/database.types.ts || exit 1
    if ! git diff --quiet packages/shared/src/types/database.types.ts; then
      echo "  ⚠️  database.types.ts was reformatted. Please commit the changes and push again."
      exit 1
    fi
  else
    echo "  → database.types.ts was deleted, skipping formatting"
  fi
fi

echo "[husky] checking TypeScript types..."
bun run tsc || exit 1

echo "[husky] running core unit tests (quiet)..."
CI=1 bun run test:pkg-unit -- --reporter=dot --silent > .husky/.prepush_core.log 2>&1 || { echo "[husky] core unit tests failed. See .husky/.prepush_core.log"; tail -n 120 .husky/.prepush_core.log; exit 1; }

echo "[husky] running gate tests (quiet)..."
CI=1 bun run test:gate -- --reporter=dot --silent > .husky/.prepush_gate.log 2>&1 || { echo "[husky] gate tests failed. See .husky/.prepush_gate.log"; tail -n 120 .husky/.prepush_gate.log; exit 1; }

