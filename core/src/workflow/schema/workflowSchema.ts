import { z } from "zod"

import { agentDescriptionsWithTools } from "@core/node/schemas/agentWithTools"
import {
  ACTIVE_CODE_TOOL_NAMES_WITH_DEFAULT,
  ACTIVE_MCP_TOOL_NAMES,
} from "@core/tools/tool.types"
import { MemorySchemaOptional } from "@core/utils/memory/memorySchema"
import type { ModelNameV2 } from "@core/utils/spending/models.types"
import { ACTIVE_MODEL_NAMES } from "@core/utils/spending/pricing"
import { withDescriptions } from "@core/utils/zod/withDescriptions"
import type {
  WorkflowConfig,
  WorkflowNodeConfig,
} from "@core/workflow/schema/workflow.types"
import { getDefaultModels } from "@runtime/settings/models"

export const WorkflowNodeConfigSchema = z.object({
  nodeId: z.string(),
  description: z.string(),
  systemPrompt: z.string(),
  modelName: z.enum(ACTIVE_MODEL_NAMES),
  mcpTools: z.array(z.enum(ACTIVE_MCP_TOOL_NAMES)),
  codeTools: z.array(z.enum(ACTIVE_CODE_TOOL_NAMES_WITH_DEFAULT)),
  handOffs: z.array(z.string()),
  handOffType: z.enum(["conditional", "sequential", "parallel"]).optional(),
  memory: MemorySchemaOptional,
})

export const WorkflowConfigSchema = z.object({
  nodes: z.array(WorkflowNodeConfigSchema),
  entryNodeId: z.string(),
  contextFile: z.string().nullish(),
  memory: MemorySchemaOptional,
})

// Display-only schema that allows any model name for legacy workflows
export const WorkflowNodeConfigSchemaDisplay = z.object({
  nodeId: z.string(),
  description: z.string(),
  systemPrompt: z.string(),
  modelName: z.string(), // Allow any string for display
  mcpTools: z.array(z.string()), // Allow any string for legacy tools
  codeTools: z.array(z.string()), // Allow any string for legacy tools
  handOffs: z.array(z.string()),
  handOffType: z.enum(["conditional", "sequential", "parallel"]).optional(),
  memory: MemorySchemaOptional,
})

export const WorkflowConfigSchemaDisplay = z.object({
  nodes: z.array(WorkflowNodeConfigSchemaDisplay),
  entryNodeId: z.string(),
  contextFile: z.string().nullish(),
  memory: MemorySchemaOptional,
})

const modelNames = ["low", "medium", "high"] as const

export const WorkflowNodeConfigSchemaEasy = z.object({
  nodeId: z.string(),
  description: z.string(),
  systemPrompt: z.string(),
  modelName: z.enum(modelNames),
  mcpTools: z.array(z.enum(ACTIVE_MCP_TOOL_NAMES)),
  codeTools: z.array(z.enum(ACTIVE_CODE_TOOL_NAMES_WITH_DEFAULT)),
  handOffs: z.array(z.string()),
  handOffType: z.enum(["conditional", "sequential", "parallel"]).optional(),
})

export const WorkflowConfigSchemaEasy = z.object({
  nodes: z.array(
    withDescriptions(
      WorkflowNodeConfigSchemaEasy.shape,
      agentDescriptionsWithTools
    )
  ),
  entryNodeId: z.string(),
})

// adds memory and other fields that were just generated by the easy workflow generator
export const handleWorkflowCompletion = (
  oldWorkflow: WorkflowConfig | null,
  newWorkflow: z.infer<typeof WorkflowConfigSchemaEasy>
): WorkflowConfig => {
  const handledNodes: WorkflowNodeConfig[] = (newWorkflow.nodes ?? []).map(
    (partialNode) => {
      const oldNode = oldWorkflow?.nodes?.find(
        (n) => n.nodeId === partialNode.nodeId
      )
      const modelName: ModelNameV2 =
        partialNode.modelName === "medium"
          ? getDefaultModels().medium
          : partialNode.modelName === "high"
            ? getDefaultModels().high
            : getDefaultModels().default

      const fullNode = { ...partialNode, modelName }
      return oldNode ? { ...oldNode, ...fullNode } : fullNode
    }
  )

  return {
    ...newWorkflow,
    nodes: handledNodes, // overrides the spread-in value safely
  }
}
